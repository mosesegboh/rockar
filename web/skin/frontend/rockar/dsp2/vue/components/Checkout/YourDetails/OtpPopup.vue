<template>
    <div class="modal-dialog">
        <div class="modal-content">
            <p class="modal-header otp-popup-header">
                {{ 'One Time Pin' | translate }}
            </p>

            <p class="otp-notice">
                {{ 'As an existing client of BMW Financial Services, we can auto-fill part of your new' | translate }}
                {{ 'application for your convenience. We\'ve sent an OTP to ' | translate }}
                {{ formattedPhone }}
                {{ ' to verify your identity.' | translate }}
            </p>

            <div class="otp-password">
                <input v-for="(index, char) in codeChars"
                    v-model="char"
                    :key="index"
                    track-by="$index"
                    type="text"
                    class="otp-password-input"
                    v-on:keyup="jumpToNextChar"
                    maxlength="1"
                >
            </div>

            <div class="request-otp">
                <a href="javascript:void(0)" @click="requestNewOtp()">{{ 'Resend OTP' | translate }}</a>
            </div>

            <app-global-warning
                type="error"
                :message="this.getErrorMessage().errorMessage"
                :show="this.getErrorMessage().showErrorMessage"
            >
            </app-global-warning>

            <app-global-warning
                type="success"
                :message="this.getSuccessMessage()"
                :show="otpData.refreshed"
            >
            </app-global-warning>

            <div class="buttons">
                <button type="button" @click="skip()"
                    name="skip"
                    class="button dsp2-outline">
                    {{ 'Skip' | translate }}
                </button>

                <button type="button" @click="submitOtp()"
                    :disabled="otpData.retryAttempts === 0 || countdown === 0"
                    name="otp_submit"
                    class="button">
                    {{ 'Continue' | translate }}
                </button>
            </div>

            <p class="timer">
                {{ 'Your OTP expires in ' | translate }}
                <span>{{ showCountdown }}</span>
            </p>
        </div>


    </div>
</template>

<script>
    import appGlobalWarning from 'dsp2/components/Elements/GlobalWarning';

    export default Vue.extend({
        props: {
            creditAppData: {
                required: true,
                type: Object
            },

            otpData: {
                required: true,
                type: [Boolean, Object]
            }
        },

        data() {
            return {
                codeChars: [],
                countdown: this.creditAppData.countdownExpires,
                timer: null
            };
        },

        computed: {
            formattedPhone() {
                if (this.otpData.response === false) {
                    return '';
                }

                return this.otpData.response.authentication.cellNoForOTP;
            },

            otpLength() {
                if (this.otpData.response === false) {
                    return 5;
                }

                return this.otpData.response.authentication.otpLength;
            },

            otpCode() {
                return this.codeChars.join('');
            },

            showCountdown() {
                const minutes = parseInt(this.countdown / 60);
                let seconds = this.countdown % 60;

                if (seconds < 10) {
                    seconds = `0${seconds}`;
                }

                return `${minutes}:${seconds}`;
            }
        },

        methods: {
            requestNewOtp() {
                this.initCodeChars();
                this.countdown = this.creditAppData.countdownExpires;
                this.$dispatch('CheckoutCreditAppAccordionGroup::RefreshOTP');
            },

            skip() {
                this.closeModal();
                this.$dispatch('CheckoutCreditAppAccordionGroup::Cancel');
            },

            submitOtp() {
                this.$dispatch('CheckoutCreditAppAccordionGroup::Submit', this.otpCode);
            },

            closeModal() {
                this.$parent.closePopup();
            },

            jumpToNextChar(e) {
                const value = parseInt(e.key);
                const target = e.target;

                if (Number.isInteger(value)) {
                    target.value = value;
                    if (target.value.length > 0) {
                        if (target.nextElementSibling) {
                            target.nextElementSibling.focus();
                        }
                    }
                }
            },

            initCodeChars() {
                this.codeChars.splice(0, this.codeChars.length);
                while (this.codeChars.length < this.otpLength) {
                    this.codeChars.push('');
                }
            },

            getErrorMessage() {
                let errorMessage = '',
                    showErrorMessage = false;

                if (this.otpData.retryAttempts !== 0) {
                    if (this.countdown === 0) {
                        showErrorMessage = true;
                        errorMessage = 'Your session has timed out. Please request a new OTP to continue or skip this step';
                    } else if (this.otpData.failResponse) {
                        showErrorMessage = true;
                        errorMessage = 'Failed to process your request. Please contact support for details.';
                    } else if (this.otpData.failAttempt) {
                        showErrorMessage = true;
                        errorMessage = 'The OTP you\'ve entered is invalid.'

                        if (this.otpData.retryAttempts) {
                            errorMessage += this.otpData.retryAttempts === 1 ? ' You have one remaining attempt.'
                                : ` You have ${this.otpData.retryAttempts} remaining attempts.`;
                        }

                        errorMessage += ' Please check your SMS carefully and try again.';
                    }
                } else if (this.otpData.retryAttempts === 0 && this.creditAppData.totalAttempts) {
                    showErrorMessage = true;
                    errorMessage = `You\'ve entered an invalid OTP ${this.creditAppData.totalAttempts} times.
                    For you security, please request a new OTP and try again.`
                }

                return { showErrorMessage, errorMessage };
            },

            getSuccessMessage() {
                return `A new OTP has been sent to ${this.formattedPhone}`;
            }
        },

        ready() {
            this.initCodeChars();
        },

        watch: {
            'otpLength'() {
                this.initCodeChars();
            },

            countdown: {
                handler(value) {
                    clearTimeout(this.timer);

                    if (value > 0) {
                        this.timer = setTimeout(() => {
                            this.countdown--;
                        }, 1000);
                    }
                },
                immediate: true
            },

            '$parent.show'(result) {
                clearTimeout(this.timer);

                if (result) {
                    this.countdown = this.creditAppData.countdownExpires;
                }
            }
        },

        components: {
            appGlobalWarning
        }
    });
</script>
